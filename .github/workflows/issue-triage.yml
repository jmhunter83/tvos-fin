name: Issue Triage with Claude
# Triggered when new issues are opened

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage Issue with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          # Using github-script which handles inputs safely through JavaScript
          # (not shell interpolation) - see https://github.com/actions/github-script
          script: |
            const issue = context.payload.issue;
            const title = issue.title;
            const body = issue.body || '';

            // Skip if already labeled (except 'bug' which is auto-added by template)
            const existingLabels = issue.labels.map(l => l.name);
            const hasTriageLabels = existingLabels.some(l =>
              l.startsWith('severity:') || l.startsWith('area:') || l.startsWith('type:')
            );
            if (hasTriageLabels) {
              console.log('Issue already triaged, skipping');
              return;
            }

            // Available labels
            const severityLabels = ['severity: critical', 'severity: high', 'severity: medium', 'severity: low'];
            const areaLabels = ['area: playback', 'area: library', 'area: ui', 'area: auth', 'area: sync', 'area: settings'];
            const typeLabels = ['type: crash', 'type: regression', 'type: performance'];

            const prompt = `You are a bug triage assistant for Reefy, a tvOS Jellyfin media player app.

Analyze this GitHub issue and suggest appropriate labels.

ISSUE TITLE: ${title}

ISSUE BODY:
${body}

Based on the issue content, respond with a JSON object containing:
1. "severity": one of [critical, high, medium, low]
   - critical: App crash, data loss, security issue
   - high: Major feature broken, no workaround
   - medium: Feature impaired, workaround exists
   - low: Minor issue, cosmetic

2. "area": one of [playback, library, ui, auth, sync, settings, other]
   - playback: Video/audio playback issues
   - library: Media browsing, search, collections
   - ui: User interface, layout, navigation, focus
   - auth: Authentication, server connection
   - sync: Downloads, offline content
   - settings: Preferences, configuration

3. "type": one of [crash, regression, performance, null]
   - crash: App crashes or freezes
   - regression: Previously worked, now broken
   - performance: Slow, laggy, resource intensive
   - null: If none apply

4. "confidence": number 0-100 indicating how confident you are

5. "reasoning": brief explanation (1-2 sentences)

Respond ONLY with valid JSON, no other text.`;

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-3-haiku-20240307',
                  max_tokens: 256,
                  messages: [{
                    role: 'user',
                    content: prompt
                  }]
                })
              });

              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }

              const data = await response.json();
              const content = data.content[0].text;
              const analysis = JSON.parse(content);

              console.log('Claude analysis:', analysis);

              // Only apply labels if confidence >= 70
              if (analysis.confidence < 70) {
                console.log(`Low confidence (${analysis.confidence}), skipping auto-label`);
                // Add comment instead
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ðŸ¤– **Auto-triage suggestion** (confidence: ${analysis.confidence}%)\n\n` +
                        `- Severity: \`${analysis.severity}\`\n` +
                        `- Area: \`${analysis.area}\`\n` +
                        (analysis.type ? `- Type: \`${analysis.type}\`\n` : '') +
                        `\n${analysis.reasoning}\n\n` +
                        `*Low confidence - labels not auto-applied. Please review and apply manually.*`
                });
                return;
              }

              // Build labels to add
              const labelsToAdd = [];

              if (analysis.severity && severityLabels.includes(`severity: ${analysis.severity}`)) {
                labelsToAdd.push(`severity: ${analysis.severity}`);
              }

              if (analysis.area && analysis.area !== 'other' && areaLabels.includes(`area: ${analysis.area}`)) {
                labelsToAdd.push(`area: ${analysis.area}`);
              }

              if (analysis.type && typeLabels.includes(`type: ${analysis.type}`)) {
                labelsToAdd.push(`type: ${analysis.type}`);
              }

              if (labelsToAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labelsToAdd
                });

                console.log(`Applied labels: ${labelsToAdd.join(', ')}`);

                // Add comment explaining the triage
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ðŸ¤– **Auto-triaged** (confidence: ${analysis.confidence}%)\n\n` +
                        `Applied labels: ${labelsToAdd.map(l => `\`${l}\``).join(', ')}\n\n` +
                        `${analysis.reasoning}`
                });
              }

            } catch (error) {
              console.error('Triage failed:', error.message);
              // Don't fail the workflow, just log the error
            }
